<!DOCTYPE html>
<html lang="pt-br" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="description" content="Softphone WSS - Sistema de telefonia VoIP WebSocket">
  <title>Softphone WSS</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --transition-fast: 0.15s ease;
      --transition: 0.25s ease;
      --radius-sm: 6px;
      --radius: 10px;
      --radius-lg: 14px;
    }

    /* Dark Theme */
    [data-theme="dark"] {
      --bg-base: #08080c;
      --bg-primary: #0c0c12;
      --bg-secondary: #13131b;
      --bg-tertiary: #1a1a24;
      --bg-input: #1e1e2a;
      --bg-hover: #252532;
      --text-primary: #f4f4f6;
      --text-secondary: #9898a8;
      --text-muted: #5c5c6e;
      --border: #26263a;
      --border-focus: #3b82f6;
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --accent-glow: rgba(59, 130, 246, 0.25);
      --success: #10b981;
      --success-hover: #059669;
      --success-glow: rgba(16, 185, 129, 0.3);
      --danger: #ef4444;
      --danger-hover: #dc2626;
      --danger-glow: rgba(239, 68, 68, 0.3);
      --warning: #f59e0b;
      --warning-glow: rgba(245, 158, 11, 0.3);
      --shadow: 0 4px 24px rgba(0, 0, 0, 0.5);
    }

    /* Light Theme */
    [data-theme="light"] {
      --bg-base: #f5f7fa;
      --bg-primary: #ffffff;
      --bg-secondary: #f8f9fb;
      --bg-tertiary: #eef1f5;
      --bg-input: #e8ecf2;
      --bg-hover: #dfe4eb;
      --text-primary: #0f172a;
      --text-secondary: #475569;
      --text-muted: #94a3b8;
      --border: #e2e8f0;
      --border-focus: #3b82f6;
      --accent: #2563eb;
      --accent-hover: #1d4ed8;
      --accent-glow: rgba(37, 99, 235, 0.15);
      --success: #059669;
      --success-hover: #047857;
      --success-glow: rgba(5, 150, 105, 0.2);
      --danger: #dc2626;
      --danger-hover: #b91c1c;
      --danger-glow: rgba(220, 38, 38, 0.2);
      --warning: #d97706;
      --warning-glow: rgba(217, 119, 6, 0.2);
      --shadow: 0 4px 24px rgba(0, 0, 0, 0.1);
    }

    /* Green Theme */
    [data-theme="green"] {
      --bg-base: #000000;
      --bg-primary: #050805;
      --bg-secondary: #0a100a;
      --bg-tertiary: #0f180f;
      --bg-input: #121f12;
      --bg-hover: #1a2a1a;
      --text-primary: #b8ff00;
      --text-secondary: #7cb800;
      --text-muted: #3d6400;
      --border: #1a3a1a;
      --border-focus: #b8ff00;
      --accent: #b8ff00;
      --accent-hover: #9adf00;
      --accent-glow: rgba(184, 255, 0, 0.2);
      --success: #b8ff00;
      --success-hover: #9adf00;
      --success-glow: rgba(184, 255, 0, 0.3);
      --danger: #ff3333;
      --danger-hover: #cc2222;
      --danger-glow: rgba(255, 51, 51, 0.3);
      --warning: #ffcc00;
      --warning-glow: rgba(255, 204, 0, 0.3);
      --shadow: 0 4px 24px rgba(0, 0, 0, 0.8);
    }

    html {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg-base);
      min-height: 100vh;
      min-height: 100dvh;
      color: var(--text-primary);
      transition: background var(--transition), color var(--transition);
      line-height: 1.5;
    }

    .app {
      max-width: 420px;
      margin: 0 auto;
      padding: 12px;
      min-height: 100vh;
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 0;
      margin-bottom: 12px;
      flex-shrink: 0;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-icon {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--accent), var(--accent-hover));
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px var(--accent-glow);
    }

    .logo-icon svg {
      width: 18px;
      height: 18px;
      fill: #fff;
    }

    [data-theme="green"] .logo-icon svg {
      fill: #000;
    }

    .logo-text {
      font-size: 17px;
      font-weight: 700;
      letter-spacing: -0.3px;
    }

    .logo-badge {
      font-size: 9px;
      font-weight: 600;
      background: var(--accent);
      color: #fff;
      padding: 2px 6px;
      border-radius: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-left: -4px;
    }

    [data-theme="green"] .logo-badge {
      color: #000;
    }

    /* Theme Switcher */
    .theme-switcher {
      display: flex;
      gap: 3px;
      background: var(--bg-secondary);
      padding: 3px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }

    .theme-btn {
      width: 30px;
      height: 30px;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      transition: all var(--transition-fast);
      position: relative;
    }

    .theme-btn::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: var(--accent);
      opacity: 0;
      transition: opacity var(--transition-fast);
    }

    .theme-btn:hover::before {
      opacity: 0.1;
    }

    .theme-btn.active {
      background: var(--accent);
      box-shadow: 0 2px 8px var(--accent-glow);
    }

    .theme-btn svg {
      width: 14px;
      height: 14px;
      fill: var(--text-muted);
      position: relative;
      z-index: 1;
      transition: fill var(--transition-fast);
    }

    .theme-btn:hover svg {
      fill: var(--text-secondary);
    }

    .theme-btn.active svg {
      fill: #fff;
    }

    [data-theme="green"] .theme-btn.active svg {
      fill: #000;
    }

    /* Status Bar */
    .status-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      background: var(--bg-secondary);
      border-radius: var(--radius);
      margin-bottom: 12px;
      border: 1px solid var(--border);
      flex-shrink: 0;
    }

    .status-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--danger);
      flex-shrink: 0;
      position: relative;
    }

    .status-dot::after {
      content: '';
      position: absolute;
      inset: -3px;
      border-radius: 50%;
      background: inherit;
      opacity: 0;
      animation: none;
    }

    .status-dot.online {
      background: var(--success);
    }

    .status-dot.online::after {
      opacity: 0.4;
      animation: pulse 2s ease-in-out infinite;
    }

    .status-dot.connecting {
      background: var(--warning);
      animation: blink 0.8s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 0.4; }
      50% { transform: scale(1.5); opacity: 0; }
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    .status-text {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .status-user {
      font-size: 12px;
      color: var(--text-muted);
      font-weight: 500;
    }

    /* Tabs com mais abas */
    .tabs {
      display: flex;
      gap: 2px;
      background: var(--bg-secondary);
      padding: 3px;
      border-radius: var(--radius);
      margin-bottom: 12px;
      border: 1px solid var(--border);
      flex-shrink: 0;
      overflow-x: auto;
    }

    .tab {
      flex: 1;
      padding: 10px 4px;
      border: none;
      border-radius: var(--radius-sm);
      background: transparent;
      color: var(--text-muted);
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-fast);
      position: relative;
      white-space: nowrap;
      min-width: 0;
    }

    .tab::after {
      content: '';
      position: absolute;
      bottom: 4px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 2px;
      background: var(--accent);
      border-radius: 1px;
      transition: width var(--transition-fast);
    }

    .tab:hover {
      color: var(--text-secondary);
    }

    .tab.active {
      background: var(--bg-primary);
      color: var(--text-primary);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .tab.active::after {
      width: 16px;
    }

    /* Panels */
    .panel {
      display: none;
      flex: 1;
      min-height: 0;
    }

    .panel.active {
      display: flex;
      flex-direction: column;
    }

    /* Config Form */
    .config-scroll {
      flex: 1;
      overflow-y: auto;
      padding-right: 4px;
    }

    .form-group {
      margin-bottom: 12px;
    }

    .form-label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-input {
      width: 100%;
      padding: 12px 14px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text-primary);
      font-size: 14px;
      font-family: inherit;
      transition: all var(--transition-fast);
    }

    .form-input:focus {
      outline: none;
      border-color: var(--border-focus);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }

    .form-input::placeholder {
      color: var(--text-muted);
    }

    .form-input.error {
      border-color: var(--danger);
      box-shadow: 0 0 0 3px var(--danger-glow);
      animation: shake 0.3s ease;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-4px); }
      75% { transform: translateX(4px); }
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    /* Buttons */
    .btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: var(--radius);
      font-size: 14px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all var(--transition-fast);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, rgba(255,255,255,0.1) 0%, transparent 100%);
      opacity: 0;
      transition: opacity var(--transition-fast);
    }

    .btn:hover::before {
      opacity: 1;
    }

    .btn svg {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
    }

    .btn-primary {
      background: var(--accent);
      color: #fff;
      box-shadow: 0 2px 8px var(--accent-glow);
    }

    [data-theme="green"] .btn-primary {
      color: #000;
    }

    .btn-primary:hover:not(:disabled) {
      background: var(--accent-hover);
      transform: translateY(-1px);
    }

    .btn-primary:active:not(:disabled) {
      transform: translateY(0);
    }

    .btn-success {
      background: var(--success);
      color: #fff;
      box-shadow: 0 2px 8px var(--success-glow);
    }

    .btn-success:hover:not(:disabled) {
      background: var(--success-hover);
    }

    .btn-danger {
      background: var(--danger);
      color: #fff;
    }

    .btn-danger:hover:not(:disabled) {
      background: var(--danger-hover);
    }

    .btn-outline {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      color: var(--text-secondary);
    }

    .btn-outline:hover:not(:disabled) {
      background: var(--bg-hover);
      color: var(--text-primary);
      border-color: var(--text-muted);
    }

    .btn-sm {
      padding: 8px 12px;
      font-size: 12px;
    }

    .btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none !important;
    }

    /* Dialer */
    .dialer-display {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 20px;
      margin-bottom: 12px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .dialer-display::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--border), transparent);
    }

    .dialer-number {
      font-size: 28px;
      font-weight: 700;
      letter-spacing: 1px;
      min-height: 40px;
      color: var(--text-primary);
      word-break: break-all;
      font-variant-numeric: tabular-nums;
    }

    .dialer-status {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 6px;
      font-weight: 500;
    }

    .call-timer {
      font-size: 16px;
      color: var(--success);
      font-weight: 700;
      margin-top: 8px;
      display: none;
      font-variant-numeric: tabular-nums;
    }

    .call-timer.active {
      display: block;
    }

    /* Voice Animation */
    .voice-animation {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      display: none;
      align-items: flex-end;
      gap: 3px;
      height: 40px;
      padding: 4px;
      background: var(--bg-tertiary);
      border-radius: 8px;
    }

    .voice-animation.active {
      display: flex;
    }

    .voice-bar {
      width: 4px;
      background: linear-gradient(to top, var(--success), var(--success-hover));
      border-radius: 2px;
      transform-origin: bottom;
    }

    .voice-bar:nth-child(1) { animation: voice1 0.5s ease-in-out infinite; }
    .voice-bar:nth-child(2) { animation: voice2 0.4s ease-in-out infinite 0.1s; }
    .voice-bar:nth-child(3) { animation: voice3 0.6s ease-in-out infinite 0.05s; }
    .voice-bar:nth-child(4) { animation: voice4 0.45s ease-in-out infinite 0.15s; }
    .voice-bar:nth-child(5) { animation: voice5 0.55s ease-in-out infinite 0.08s; }

    @keyframes voice1 { 0%, 100% { height: 8px; } 50% { height: 28px; } }
    @keyframes voice2 { 0%, 100% { height: 12px; } 50% { height: 32px; } }
    @keyframes voice3 { 0%, 100% { height: 6px; } 50% { height: 24px; } }
    @keyframes voice4 { 0%, 100% { height: 10px; } 50% { height: 30px; } }
    @keyframes voice5 { 0%, 100% { height: 8px; } 50% { height: 20px; } }

    /* Network Stats no Dialer */
    .network-stats {
      display: none;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }

    .network-stats.active {
      display: block;
    }

    .network-stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    .network-stat {
      text-align: center;
    }

    .network-stat-value {
      font-size: 14px;
      font-weight: 700;
      color: var(--text-primary);
      font-variant-numeric: tabular-nums;
    }

    .network-stat-value.good { color: var(--success); }
    .network-stat-value.medium { color: var(--warning); }
    .network-stat-value.bad { color: var(--danger); }

    .network-stat-label {
      font-size: 9px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 2px;
    }

    /* Keypad */
    .keypad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 12px;
    }

    .key {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px 8px;
      cursor: pointer;
      transition: all var(--transition-fast);
      display: flex;
      flex-direction: column;
      align-items: center;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }

    .key:hover {
      background: var(--bg-hover);
      border-color: var(--text-muted);
      transform: scale(1.02);
    }

    .key:active {
      transform: scale(0.95);
      background: var(--bg-tertiary);
    }

    .key-number {
      font-size: 22px;
      font-weight: 600;
      color: var(--text-primary);
      line-height: 1;
    }

    .key-letters {
      font-size: 9px;
      color: var(--text-muted);
      letter-spacing: 2px;
      margin-top: 4px;
      height: 11px;
      font-weight: 500;
    }

    /* Call Controls */
    .call-controls {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
    }

    .call-btn {
      padding: 14px;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      transition: all var(--transition-fast);
      display: flex;
      align-items: center;
      justify-content: center;
      -webkit-tap-highlight-color: transparent;
    }

    .call-btn svg {
      width: 22px;
      height: 22px;
    }

    .call-btn.call {
      background: var(--success);
      box-shadow: 0 2px 12px var(--success-glow);
    }

    .call-btn.call:hover:not(:disabled) {
      background: var(--success-hover);
      transform: scale(1.02);
    }

    .call-btn.call:active:not(:disabled) {
      transform: scale(0.98);
    }

    .call-btn.call svg {
      fill: #fff;
    }

    .call-btn.hangup {
      background: var(--danger);
      box-shadow: 0 2px 12px var(--danger-glow);
    }

    .call-btn.hangup:hover:not(:disabled) {
      background: var(--danger-hover);
      transform: scale(1.02);
    }

    .call-btn.hangup:active:not(:disabled) {
      transform: scale(0.98);
    }

    .call-btn.hangup svg {
      fill: #fff;
    }

    .call-btn.clear {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
    }

    .call-btn.clear:hover {
      background: var(--bg-hover);
    }

    .call-btn.clear svg {
      fill: var(--text-secondary);
    }

    /* Contatos Panel Styles */
    .contacts-container {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      overflow: hidden;
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .contacts-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .contacts-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .contacts-count {
      font-size: 10px;
      color: var(--text-muted);
      background: var(--bg-tertiary);
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: 8px;
    }

    .contacts-search {
      padding: 10px 14px;
      border-bottom: 1px solid var(--border);
    }

    .contacts-search-input {
      width: 100%;
      padding: 10px 12px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-size: 13px;
      font-family: inherit;
    }

    .contacts-search-input:focus {
      outline: none;
      border-color: var(--border-focus);
    }

    .contacts-search-input::placeholder {
      color: var(--text-muted);
    }

    .contacts-area {
      flex: 1;
      overflow-y: auto;
      padding: 10px 12px;
      min-height: 0;
    }

    .contacts-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-muted);
      text-align: center;
      padding: 20px;
    }

    .contacts-empty-icon {
      width: 48px;
      height: 48px;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    .contacts-empty-icon svg {
      width: 100%;
      height: 100%;
      fill: var(--text-muted);
    }

    .contact-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--bg-tertiary);
      border-radius: var(--radius);
      margin-bottom: 8px;
      border: 1px solid var(--border);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .contact-item:hover {
      background: var(--bg-hover);
      border-color: var(--text-muted);
    }

    .contact-item:last-child {
      margin-bottom: 0;
    }

    .contact-avatar {
      width: 40px;
      height: 40px;
      background: var(--accent-glow);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 700;
      color: var(--accent);
      flex-shrink: 0;
    }

    .contact-info {
      flex: 1;
      min-width: 0;
    }

    .contact-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .contact-number {
      font-size: 12px;
      color: var(--text-muted);
      font-variant-numeric: tabular-nums;
    }

    .contact-actions {
      display: flex;
      gap: 4px;
    }

    .contact-action-btn {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: var(--radius-sm);
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all var(--transition-fast);
    }

    .contact-action-btn:hover {
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    .contact-action-btn.call:hover {
      background: var(--success-glow);
      color: var(--success);
    }

    .contact-action-btn.favorite:hover,
    .contact-action-btn.favorite.active {
      background: var(--warning-glow);
      color: var(--warning);
    }

    .contact-action-btn.delete:hover {
      background: var(--danger-glow);
      color: var(--danger);
    }

    .contact-action-btn svg {
      width: 16px;
      height: 16px;
      fill: currentColor;
    }

    .contacts-add-form {
      padding: 14px;
      border-top: 1px solid var(--border);
      background: var(--bg-tertiary);
    }

    /* Novo grid para incluir botao Salvar separado */
    .contacts-add-row {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .contacts-add-inputs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .contacts-add-actions {
      display: flex;
      gap: 8px;
    }

    .contacts-add-input {
      padding: 10px 12px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-size: 13px;
      font-family: inherit;
    }

    .contacts-add-input:focus {
      outline: none;
      border-color: var(--border-focus);
    }

    .contacts-add-btn {
      flex: 1;
      padding: 10px 16px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-fast);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    [data-theme="green"] .contacts-add-btn {
      color: #000;
    }

    .contacts-add-btn:hover {
      background: var(--accent-hover);
    }

    .contacts-add-btn.save-btn {
      background: var(--success);
    }

    .contacts-add-btn.save-btn:hover {
      background: var(--success-hover);
    }

    .contacts-add-btn svg {
      width: 14px;
      height: 14px;
      fill: currentColor;
    }


    /* Favoritos Panel Styles */
    .favorites-container {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      overflow: hidden;
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .favorites-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .favorites-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .favorites-count {
      font-size: 10px;
      color: var(--text-muted);
      background: var(--bg-tertiary);
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: 8px;
    }

    .favorites-area {
      flex: 1;
      overflow-y: auto;
      padding: 10px 12px;
      min-height: 0;
    }

    .favorites-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-muted);
      text-align: center;
      padding: 20px;
    }

    .favorites-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .favorite-item {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px 12px;
      text-align: center;
      cursor: pointer;
      transition: all var(--transition-fast);
      position: relative;
    }

    .favorite-item:hover {
      background: var(--bg-hover);
      border-color: var(--warning);
      transform: translateY(-2px);
    }

    .favorite-item-star {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 16px;
      height: 16px;
      fill: var(--warning);
    }

    .favorite-item-avatar {
      width: 48px;
      height: 48px;
      background: var(--warning-glow);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: 700;
      color: var(--warning);
      margin: 0 auto 10px;
    }

    .favorite-item-name {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .favorite-item-number {
      font-size: 11px;
      color: var(--text-muted);
      font-variant-numeric: tabular-nums;
    }

    /* Log Panel */
    .log-container {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      overflow: hidden;
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .log-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .log-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .log-count {
      font-size: 10px;
      color: var(--text-muted);
      background: var(--bg-tertiary);
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: 8px;
    }

    .log-clear-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: var(--radius-sm);
      transition: all var(--transition-fast);
    }

    .log-clear-btn:hover {
      color: var(--accent);
      background: var(--bg-hover);
    }

    .log-area {
      flex: 1;
      overflow-y: auto;
      padding: 10px 12px;
      font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
      font-size: 11px;
      line-height: 1.7;
      min-height: 0;
    }

    .log-entry {
      padding: 4px 0;
      display: flex;
      gap: 8px;
      border-bottom: 1px solid transparent;
      border-radius: 4px;
      margin-bottom: 2px;
    }

    .log-entry:hover {
      background: var(--bg-tertiary);
    }

    .log-time {
      color: var(--text-muted);
      flex-shrink: 0;
      font-weight: 500;
      font-size: 10px;
    }

    .log-type {
      font-size: 9px;
      font-weight: 600;
      text-transform: uppercase;
      padding: 1px 4px;
      border-radius: 3px;
      flex-shrink: 0;
    }

    .log-type.success { background: var(--success-glow); color: var(--success); }
    .log-type.error { background: var(--danger-glow); color: var(--danger); }
    .log-type.warning { background: var(--warning-glow); color: var(--warning); }
    .log-type.info { background: var(--accent-glow); color: var(--accent); }
    .log-type.debug { background: var(--bg-tertiary); color: var(--text-muted); }

    .log-msg {
      color: var(--text-secondary);
      word-break: break-word;
      flex: 1;
    }

    .log-msg.success { color: var(--success); }
    .log-msg.error { color: var(--danger); }
    .log-msg.warning { color: var(--warning); }
    .log-msg.info { color: var(--accent); }

    /* Transcript Panel Styles */
    .transcript-container {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      overflow: hidden;
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .transcript-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .transcript-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .transcript-count {
      font-size: 10px;
      color: var(--text-muted);
      background: var(--bg-tertiary);
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: 8px;
    }

    .transcript-actions {
      display: flex;
      gap: 8px;
    }

    .transcript-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: var(--radius-sm);
      transition: all var(--transition-fast);
    }

    .transcript-btn:hover {
      color: var(--accent);
      background: var(--bg-hover);
    }

    .transcript-area {
      flex: 1;
      overflow-y: auto;
      padding: 10px 12px;
      min-height: 0;
    }

    .transcript-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-muted);
      text-align: center;
      padding: 20px;
    }

    .transcript-empty-icon {
      width: 48px;
      height: 48px;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    .transcript-empty-icon svg {
      width: 100%;
      height: 100%;
      fill: var(--text-muted);
    }

    .transcript-empty-text {
      font-size: 13px;
      font-weight: 500;
    }

    .transcript-empty-hint {
      font-size: 11px;
      margin-top: 4px;
      opacity: 0.7;
    }

    .transcript-call {
      background: var(--bg-tertiary);
      border-radius: var(--radius);
      padding: 14px;
      margin-bottom: 10px;
      border: 1px solid var(--border);
    }

    .transcript-call-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border);
    }

    .transcript-call-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .transcript-call-number {
      font-size: 15px;
      font-weight: 700;
      color: var(--text-primary);
      font-variant-numeric: tabular-nums;
    }

    .transcript-call-date {
      font-size: 11px;
      color: var(--text-muted);
    }

    .transcript-call-badge {
      font-size: 10px;
      font-weight: 600;
      padding: 4px 8px;
      border-radius: var(--radius-sm);
      text-transform: uppercase;
    }

    .transcript-call-badge.incoming {
      background: var(--accent-glow);
      color: var(--accent);
    }

    .transcript-call-badge.outgoing {
      background: var(--success-glow);
      color: var(--success);
    }

    .transcript-call-badge.missed {
      background: var(--danger-glow);
      color: var(--danger);
    }

    .transcript-call-stats {
      display: flex;
      gap: 16px;
    }

    .transcript-stat {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .transcript-stat-label {
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .transcript-stat-value {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      font-variant-numeric: tabular-nums;
    }

    .transcript-call-delete {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      transition: all var(--transition-fast);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .transcript-call-delete:hover {
      color: var(--danger);
      background: var(--danger-glow);
    }

    .transcript-call-delete svg {
      width: 14px;
      height: 14px;
      fill: currentColor;
    }

    /* Export/Import Buttons */
    .data-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .data-actions .btn {
      flex: 1;
      padding: 12px;
      font-size: 12px;
    }

    /* Incoming Call Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--bg-secondary);
      border-radius: 24px;
      padding: 32px 28px;
      text-align: center;
      border: 1px solid var(--border);
      width: 100%;
      max-width: 300px;
      animation: modalIn 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
      box-shadow: var(--shadow);
    }

    @keyframes modalIn {
      from {
        opacity: 0;
        transform: scale(0.85) translateY(30px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .modal-icon {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--success), var(--success-hover));
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      animation: ring 0.6s ease-in-out infinite;
      box-shadow: 0 4px 20px var(--success-glow);
    }

    .modal-icon svg {
      width: 30px;
      height: 30px;
      fill: #fff;
    }

    @keyframes ring {
      0%, 100% { transform: rotate(0deg) scale(1); }
      25% { transform: rotate(12deg) scale(1.05); }
      75% { transform: rotate(-12deg) scale(1.05); }
    }

    .modal-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .modal-subtitle {
      color: var(--text-muted);
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 24px;
      font-variant-numeric: tabular-nums;
    }

    .modal-buttons {
      display: flex;
      gap: 12px;
    }

    .modal-buttons .btn {
      flex: 1;
      padding: 14px;
    }

    /* Scrollbar */
    .log-area::-webkit-scrollbar,
    .config-scroll::-webkit-scrollbar,
    .transcript-area::-webkit-scrollbar,
    .contacts-area::-webkit-scrollbar,
    .favorites-area::-webkit-scrollbar {
      width: 5px;
    }

    .log-area::-webkit-scrollbar-track,
    .config-scroll::-webkit-scrollbar-track,
    .transcript-area::-webkit-scrollbar-track,
    .contacts-area::-webkit-scrollbar-track,
    .favorites-area::-webkit-scrollbar-track {
      background: transparent;
    }

    .log-area::-webkit-scrollbar-thumb,
    .config-scroll::-webkit-scrollbar-thumb,
    .transcript-area::-webkit-scrollbar-thumb,
    .contacts-area::-webkit-scrollbar-thumb,
    .favorites-area::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }

    .log-area::-webkit-scrollbar-thumb:hover,
    .config-scroll::-webkit-scrollbar-thumb:hover,
    .transcript-area::-webkit-scrollbar-thumb:hover,
    .contacts-area::-webkit-scrollbar-thumb:hover,
    .favorites-area::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      padding: 12px 20px;
      border-radius: var(--radius);
      font-size: 13px;
      font-weight: 500;
      color: var(--text-primary);
      opacity: 0;
      transition: all 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
      z-index: 1001;
      box-shadow: var(--shadow);
      max-width: 90%;
      text-align: center;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    .toast.success {
      border-left: 3px solid var(--success);
    }

    .toast.error {
      border-left: 3px solid var(--danger);
    }

    .toast.warning {
      border-left: 3px solid var(--warning);
    }

    /* Credits Popup */
    .credits-popup {
      position: fixed;
      bottom: 16px;
      right: 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 0;
      font-size: 12px;
      color: var(--text-secondary);
      box-shadow: var(--shadow), 0 0 0 1px var(--border);
      z-index: 100;
      width: 220px;
      overflow: hidden;
      animation: slideInCredits 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .credits-popup.hidden {
      display: none;
    }

    @keyframes slideInCredits {
      from {
        opacity: 0;
        transform: translateX(40px) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translateX(0) scale(1);
      }
    }

    .credits-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border);
    }

    .credits-title {
      font-weight: 700;
      color: var(--text-primary);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .credits-close {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 16px;
      line-height: 1;
      padding: 4px;
      border-radius: 4px;
      transition: all var(--transition-fast);
      display: flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
    }

    .credits-close:hover {
      color: var(--text-primary);
      background: var(--bg-hover);
    }

    .credits-body {
      padding: 14px;
    }

    .credits-item {
      display: flex;
      flex-direction: column;
      margin-bottom: 12px;
    }

    .credits-item:last-child {
      margin-bottom: 0;
    }

    .credits-label {
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .credits-name {
      font-size: 13px;
      color: var(--accent);
      font-weight: 600;
    }

    .credits-divider {
      height: 1px;
      background: var(--border);
      margin: 10px 0;
    }

    /* Hidden */
    #remoteAudio,
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      border: 0;
    }

    /* Focus Visible */
    button:focus-visible,
    input:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    /* Media Queries */
    @media (max-width: 420px) {
      .app {
        padding: 10px;
      }

      .dialer-number {
        font-size: 24px;
      }

      .key {
        padding: 12px 6px;
      }

      .key-number {
        font-size: 20px;
      }

      .credits-popup {
        width: 190px;
        right: 10px;
        bottom: 10px;
      }

      .tab {
        font-size: 10px;
        padding: 10px 2px;
      }

      .contacts-add-row {
        grid-template-columns: 1fr;
      }

      .favorites-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (min-height: 800px) {
      .keypad {
        gap: 10px;
      }

      .key {
        padding: 18px 10px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Header -->
    <header class="header">
      <div class="logo">
        <div class="logo-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg>
        </div>
        <span class="logo-text">Softphone</span>
        <span class="logo-badge">WSS</span>
      </div>

      <div class="theme-switcher" role="group" aria-label="Selecionar tema">
        <button class="theme-btn active" data-theme="dark" title="Tema Escuro" aria-pressed="true">
          <svg viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.81.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/></svg>
        </button>
        <button class="theme-btn" data-theme="light" title="Tema Claro" aria-pressed="false">
          <svg viewBox="0 0 24 24"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41l-1.06-1.06zm1.06-10.96c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"/></svg>
        </button>
        <button class="theme-btn" data-theme="green" title="Tema Verde" aria-pressed="false">
          <svg viewBox="0 0 24 24"><path d="M17 8C8 10 5.9 16.17 3.82 21.34l1.89.66.95-2.3c.48.17.98.3 1.34.3C19 20 22 3 22 3c-1 2-8 2.25-13 3.25S2 11.5 2 13.5s1.75 3.75 1.75 3.75C7 8 17 8 17 8z"/></svg>
        </button>
      </div>
    </header>

    <!-- Status Bar -->
    <div class="status-bar" role="status" aria-live="polite">
      <div class="status-info">
        <span class="status-dot" id="statusDot" aria-hidden="true"></span>
        <span class="status-text" id="statusText">Desconectado</span>
      </div>
      <span class="status-user" id="statusUser">-</span>
    </div>

    <!-- Tabs com novas abas Contatos e Favoritos -->
    <nav class="tabs" role="tablist">
      <button class="tab active" data-tab="dialer" role="tab" aria-selected="true">Discador</button>
      <button class="tab" data-tab="contacts" role="tab" aria-selected="false">Contatos</button>
      <button class="tab" data-tab="favorites" role="tab" aria-selected="false">Favoritos</button>
      <button class="tab" data-tab="history" role="tab" aria-selected="false">Historico</button>
      <button class="tab" data-tab="config" role="tab" aria-selected="false">Config</button>
      <button class="tab" data-tab="log" role="tab" aria-selected="false">Log</button>
    </nav>

    <!-- Dialer Panel -->
    <section class="panel active" id="panel-dialer" role="tabpanel">
      <div class="dialer-display">
        <div class="voice-animation" id="voiceAnimation" aria-hidden="true">
          <div class="voice-bar"></div>
          <div class="voice-bar"></div>
          <div class="voice-bar"></div>
          <div class="voice-bar"></div>
          <div class="voice-bar"></div>
        </div>
        <div class="dialer-number" id="dialerNumber">&nbsp;</div>
        <div class="dialer-status" id="dialerStatus">Digite o numero</div>
        <div class="call-timer" id="callTimer" aria-live="polite">00:00</div>
        
        <!-- Network Stats durante chamada -->
        <div class="network-stats" id="networkStats">
          <div class="network-stats-grid">
            <div class="network-stat">
              <div class="network-stat-value" id="statLatency">--</div>
              <div class="network-stat-label">Latencia</div>
            </div>
            <div class="network-stat">
              <div class="network-stat-value" id="statJitter">--</div>
              <div class="network-stat-label">Jitter</div>
            </div>
            <div class="network-stat">
              <div class="network-stat-value" id="statPacketLoss">--</div>
              <div class="network-stat-label">Perda</div>
            </div>
          </div>
        </div>
      </div>

      <div class="keypad" role="group" aria-label="Teclado numerico">
        <button class="key" data-key="1" aria-label="1">
          <span class="key-number">1</span>
          <span class="key-letters" aria-hidden="true"></span>
        </button>
        <button class="key" data-key="2" aria-label="2 ABC">
          <span class="key-number">2</span>
          <span class="key-letters" aria-hidden="true">ABC</span>
        </button>
        <button class="key" data-key="3" aria-label="3 DEF">
          <span class="key-number">3</span>
          <span class="key-letters" aria-hidden="true">DEF</span>
        </button>
        <button class="key" data-key="4" aria-label="4 GHI">
          <span class="key-number">4</span>
          <span class="key-letters" aria-hidden="true">GHI</span>
        </button>
        <button class="key" data-key="5" aria-label="5 JKL">
          <span class="key-number">5</span>
          <span class="key-letters" aria-hidden="true">JKL</span>
        </button>
        <button class="key" data-key="6" aria-label="6 MNO">
          <span class="key-number">6</span>
          <span class="key-letters" aria-hidden="true">MNO</span>
        </button>
        <button class="key" data-key="7" aria-label="7 PQRS">
          <span class="key-number">7</span>
          <span class="key-letters" aria-hidden="true">PQRS</span>
        </button>
        <button class="key" data-key="8" aria-label="8 TUV">
          <span class="key-number">8</span>
          <span class="key-letters" aria-hidden="true">TUV</span>
        </button>
        <button class="key" data-key="9" aria-label="9 WXYZ">
          <span class="key-number">9</span>
          <span class="key-letters" aria-hidden="true">WXYZ</span>
        </button>
        <button class="key" data-key="*" aria-label="Asterisco">
          <span class="key-number">*</span>
          <span class="key-letters" aria-hidden="true"></span>
        </button>
        <button class="key" data-key="0" aria-label="0">
          <span class="key-number">0</span>
          <span class="key-letters" aria-hidden="true">+</span>
        </button>
        <button class="key" data-key="#" aria-label="Cerquilha">
          <span class="key-number">#</span>
          <span class="key-letters" aria-hidden="true"></span>
        </button>
      </div>

      <div class="call-controls">
        <button class="call-btn clear" id="btnClear" title="Apagar" aria-label="Apagar numero">
          <svg viewBox="0 0 24 24"><path d="M22 3H7c-.69 0-1.23.35-1.59.88L0 12l5.41 8.11c.36.53.9.89 1.59.89h15c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-3 12.59L17.59 17 14 13.41 10.41 17 9 15.59 12.59 12 9 8.41 10.41 7 14 10.59 17.59 7 19 8.41 15.41 12 19 15.59z"/></svg>
        </button>
        <button class="call-btn call" id="btnCall" disabled title="Ligar" aria-label="Fazer ligacao">
          <svg viewBox="0 0 24 24"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg>
        </button>
        <button class="call-btn hangup" id="btnHangup" disabled title="Desligar" aria-label="Encerrar ligacao">
          <svg viewBox="0 0 24 24"><path d="M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08c-.18-.17-.29-.42-.29-.7 0-.28.11-.53.29-.71C3.34 8.78 7.46 7 12 7s8.66 1.78 11.71 4.67c.18.18.29.43.29.71 0 .28-.11.53-.29.71l-2.48 2.48c-.18.18-.43.29-.71.29-.27 0-.52-.11-.7-.28-.79-.74-1.69-1.36-2.67-1.85-.33-.16-.56-.5-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"/></svg>
        </button>
      </div>
    </section>

    <!-- Novo painel Contatos -->
    <section class="panel" id="panel-contacts" role="tabpanel">
      <div class="contacts-container">
        <div class="contacts-header">
          <div style="display:flex;align-items:center;">
            <span class="contacts-title">Contatos</span>
            <span class="contacts-count" id="contactsCount">0</span>
          </div>
        </div>
        <div class="contacts-search">
          <input type="text" class="contacts-search-input" id="contactsSearch" placeholder="Buscar contato...">
        </div>
        <div class="contacts-area" id="contactsArea">
          <div class="contacts-empty" id="contactsEmpty">
            <div class="contacts-empty-icon">
              <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
            </div>
            <div class="transcript-empty-text">Nenhum contato</div>
            <div class="transcript-empty-hint">Adicione contatos usando o formulario abaixo</div>
          </div>
          <div id="contactsList"></div>
        </div>
        <!-- Formulario com botao Salvar separado -->
        <div class="contacts-add-form">
          <div class="contacts-add-row">
            <div class="contacts-add-inputs">
              <input type="text" class="contacts-add-input" id="contactName" placeholder="Nome do contato">
              <input type="tel" class="contacts-add-input" id="contactNumber" placeholder="Numero">
            </div>
            <div class="contacts-add-actions">
              <button class="contacts-add-btn" id="btnAddContact" type="button">
                <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                Adicionar
              </button>
              <button class="contacts-add-btn save-btn" id="btnSaveContacts" type="button">
                <svg viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>
                Salvar
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Novo painel Favoritos -->
    <section class="panel" id="panel-favorites" role="tabpanel">
      <div class="favorites-container">
        <div class="favorites-header">
          <div style="display:flex;align-items:center;">
            <span class="favorites-title">Favoritos</span>
            <span class="favorites-count" id="favoritesCount">0</span>
          </div>
        </div>
        <div class="favorites-area" id="favoritesArea">
          <div class="favorites-empty" id="favoritesEmpty">
            <div class="contacts-empty-icon">
              <svg viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
            </div>
            <div class="transcript-empty-text">Nenhum favorito</div>
            <div class="transcript-empty-hint">Marque contatos como favoritos para acesso rapido</div>
          </div>
          <div class="favorites-grid" id="favoritesList"></div>
        </div>
      </div>
    </section>

    <!-- Historico de Chamadas -->
    <section class="panel" id="panel-history" role="tabpanel">
      <div class="transcript-container">
        <div class="transcript-header">
          <div style="display:flex;align-items:center;">
            <span class="transcript-title">Historico</span>
            <span class="transcript-count" id="historyCount">0</span>
          </div>
          <div class="transcript-actions">
            <button class="transcript-btn" id="btnExportHistory" type="button">Exportar</button>
            <button class="transcript-btn" id="btnClearHistory" type="button">Limpar</button>
          </div>
        </div>
        <div class="transcript-area" id="historyArea">
          <div class="transcript-empty" id="historyEmpty">
            <div class="transcript-empty-icon">
              <svg viewBox="0 0 24 24"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg>
            </div>
            <div class="transcript-empty-text">Nenhuma chamada registrada</div>
            <div class="transcript-empty-hint">As chamadas realizadas aparecerao aqui</div>
          </div>
          <div id="historyList"></div>
        </div>
      </div>
    </section>

    <!-- Config Panel -->
    <section class="panel" id="panel-config" role="tabpanel">
      <div class="config-scroll">
        <div class="form-group">
          <label class="form-label" for="wss">Servidor WSS</label>
          <input type="url" class="form-input" id="wss" placeholder="wss://servidor.com:7443" autocomplete="url" spellcheck="false">
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="user">Usuario</label>
            <input type="text" class="form-input" id="user" placeholder="1001" autocomplete="username" spellcheck="false">
          </div>
          <div class="form-group">
            <label class="form-label" for="domain">Dominio</label>
            <input type="text" class="form-input" id="domain" placeholder="servidor.com" autocomplete="off" spellcheck="false">
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="pass">Senha</label>
          <input type="password" class="form-input" id="pass" placeholder="Sua senha SIP" autocomplete="current-password">
        </div>

        <button class="btn btn-primary" id="btnRegister" type="button">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
          <span id="btnRegisterText">Conectar</span>
        </button>

        <div class="data-actions">
          <button class="btn btn-outline" id="btnExport" type="button">Exportar Backup</button>
          <button class="btn btn-outline" id="btnImport" type="button">Importar Backup</button>
        </div>
        <input type="file" id="fileImport" accept=".json" class="sr-only">
      </div>
    </section>

    <!-- Log Panel -->
    <section class="panel" id="panel-log" role="tabpanel">
      <div class="log-container">
        <div class="log-header">
          <div style="display:flex;align-items:center;">
            <span class="log-title">Eventos</span>
            <span class="log-count" id="logCount">0</span>
          </div>
          <button class="log-clear-btn" id="btnClearLog" type="button">Limpar</button>
        </div>
        <div class="log-area" id="logArea" role="log" aria-live="polite"></div>
      </div>
    </section>
  </div>

  <!-- Incoming Call Modal -->
  <div class="modal-overlay" id="incomingModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal">
      <div class="modal-icon" aria-hidden="true">
        <svg viewBox="0 0 24 24"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg>
      </div>
      <div class="modal-title" id="modalTitle">Chamada Recebida</div>
      <div class="modal-subtitle" id="callerNumber">Desconhecido</div>
      <div class="modal-buttons">
        <button class="btn btn-success" id="btnAnswer" type="button">Atender</button>
        <button class="btn btn-danger" id="btnReject" type="button">Rejeitar</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast" role="alert" aria-live="assertive"></div>

  <!-- Credits Popup -->
  <aside class="credits-popup" id="creditsPopup">
    <div class="credits-header">
      <span class="credits-title">Creditos</span>
      <button class="credits-close" id="closeCreditsBtn" aria-label="Fechar creditos">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
      </button>
    </div>
    <div class="credits-body">
      <div class="credits-item">
        <span class="credits-label">Ideia / Criacao</span>
        <span class="credits-name">Yure</span>
      </div>
      <div class="credits-divider"></div>
      <div class="credits-item">
        <span class="credits-label">UI Design / Performance</span>
        <span class="credits-name">Lucas Lima</span>
      </div>
    </div>
  </aside>

  <!-- Remote Audio -->
  <audio id="remoteAudio" autoplay playsinline></audio>

  <!-- JsSIP Library -->
  <script src="./jssip.min.js"></script>

  <script>
    /**
     * Softphone WSS - Sistema VoIP WebSocket
     * @version 6.0
     * @description Softphone com Contatos, Favoritos e Estatisticas de Rede
     */
    (function() {
      'use strict';

      // ============================================
      // CONSTANTS
      // ============================================
      const VERSION = '6.0';
      const APP_NAME = 'Softphone WSS';
      
      const STORAGE_KEYS = Object.freeze({
        CONFIG: 'softphone_wss_config',
        THEME: 'softphone_wss_theme',
        LOGS: 'softphone_wss_logs',
        HISTORY: 'softphone_wss_history',
        CONTACTS: 'softphone_wss_contacts',
        CREDITS_CLOSED: 'softphone_wss_credits_closed'
      });

      const MAX_LOGS = 300;
      const MAX_HISTORY = 100;
      const MAX_CONTACTS = 500;
      const TOAST_DURATION = 3500;
      const STATUS_RESET_DELAY = 2500;
      const SAVE_DEBOUNCE_MS = 500;
      const STATS_UPDATE_INTERVAL = 1000;

      const LOG_TYPES = Object.freeze({
        INFO: 'info',
        SUCCESS: 'success',
        WARNING: 'warning',
        ERROR: 'error',
        DEBUG: 'debug'
      });

      const ERROR_CODES = Object.freeze({
        JSSIP_NOT_LOADED: 'E001',
        VALIDATION: 'E002',
        CONNECTION: 'E003',
        REGISTRATION: 'E004',
        CALL: 'E005',
        MEDIA: 'E006',
        STORAGE: 'E007',
        NETWORK: 'E008',
        WEBSOCKET: 'E009',
        SIP: 'E010',
        CONTACT: 'E011'
      });

      const SIP_ERRORS = Object.freeze({
        400: 'Requisicao mal formada',
        401: 'Nao autorizado - verifique credenciais',
        403: 'Proibido - acesso negado',
        404: 'Usuario nao encontrado',
        408: 'Timeout - servidor nao respondeu',
        480: 'Temporariamente indisponivel',
        486: 'Ocupado',
        487: 'Chamada cancelada',
        488: 'Codec nao aceito',
        500: 'Erro interno do servidor',
        502: 'Bad Gateway',
        503: 'Servico indisponivel',
        504: 'Timeout do gateway',
        600: 'Ocupado em toda parte',
        603: 'Recusado'
      });

      let jsSIPLoaded = false;
      let jsSIPVersion = 'nao carregado';
      
      function checkJsSIP() {
        if (typeof JsSIP !== 'undefined') {
          jsSIPLoaded = true;
          jsSIPVersion = JsSIP.version || '3.x';
          return true;
        }
        return false;
      }

      checkJsSIP();

      // ============================================
      // ERROR HANDLER
      // ============================================
      const ErrorHandler = {
        wrap(fn, context = 'Operacao') {
          return function(...args) {
            try {
              return fn.apply(this, args);
            } catch (error) {
              ErrorHandler.handle(error, context);
            }
          };
        },

        async wrapAsync(fn, context = 'Operacao') {
          try {
            return await fn();
          } catch (error) {
            ErrorHandler.handle(error, context);
          }
        },

        handle(error, context = 'Erro') {
          const errorMsg = error?.message || String(error);
          const errorCode = error?.code || 'UNKNOWN';
          
          console.error(`[${APP_NAME}] ${context}:`, error);
          
          if (typeof Softphone !== 'undefined' && Softphone.log) {
            Softphone.log(`[${errorCode}] ${context}: ${errorMsg}`, LOG_TYPES.ERROR);
          }
        },

        getSIPErrorMessage(code) {
          return SIP_ERRORS[code] || `Erro SIP ${code}`;
        }
      };

      // ============================================
      // UTILITY FUNCTIONS
      // ============================================
      const Utils = {
        $(id) {
          return document.getElementById(id);
        },

        $$(selector) {
          return document.querySelectorAll(selector);
        },

        debounce(fn, ms) {
          let timer;
          return function(...args) {
            clearTimeout(timer);
            timer = setTimeout(() => fn.apply(this, args), ms);
          };
        },

        formatTime(date) {
          return date.toLocaleTimeString('pt-BR', { 
            hour: '2-digit', 
            minute: '2-digit', 
            second: '2-digit' 
          });
        },

        formatDate(date) {
          return date.toLocaleDateString('pt-BR', { 
            day: '2-digit', 
            month: '2-digit', 
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
        },

        formatDuration(seconds) {
          if (!seconds || seconds < 0) return '00:00';
          const mins = Math.floor(seconds / 60);
          const secs = Math.floor(seconds % 60);
          return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        },

        generateId() {
          return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        },

        sanitizeNumber(number) {
          return String(number || '').replace(/[^\d*#]/g, '');
        },

        getInitials(name) {
          if (!name) return '?';
          const parts = name.trim().split(' ');
          if (parts.length >= 2) {
            return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
          }
          return name.substring(0, 2).toUpperCase();
        },

        isValidWSS(url) {
          if (!url) return false;
          try {
            const parsed = new URL(url);
            return parsed.protocol === 'wss:' || parsed.protocol === 'ws:';
          } catch {
            return false;
          }
        },

        isValidDomain(domain) {
          if (!domain) return false;
          const pattern = /^([a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?\.)+[a-zA-Z]{2,}$|^(\d{1,3}\.){3}\d{1,3}$/;
          return pattern.test(domain);
        },

        escapeHtml(str) {
          const div = document.createElement('div');
          div.textContent = str;
          return div.innerHTML;
        }
      };

      // ============================================
      // STORAGE MANAGER
      // ============================================
      const Storage = {
        get(key, defaultValue = null) {
          try {
            const item = localStorage.getItem(key);
            if (item === null) return defaultValue;
            return JSON.parse(item);
          } catch (error) {
            ErrorHandler.handle(error, `Storage.get(${key})`);
            return defaultValue;
          }
        },

        set(key, value) {
          try {
            localStorage.setItem(key, JSON.stringify(value));
            return true;
          } catch (error) {
            if (error.name === 'QuotaExceededError') {
              this.cleanup();
              try {
                localStorage.setItem(key, JSON.stringify(value));
                return true;
              } catch {
                ErrorHandler.handle(error, 'Storage.set - quota exceeded');
              }
            }
            ErrorHandler.handle(error, `Storage.set(${key})`);
            return false;
          }
        },

        remove(key) {
          try {
            localStorage.removeItem(key);
            return true;
          } catch (error) {
            ErrorHandler.handle(error, `Storage.remove(${key})`);
            return false;
          }
        },

        cleanup() {
          try {
            const logs = this.get(STORAGE_KEYS.LOGS, []);
            if (logs.length > 50) {
              this.set(STORAGE_KEYS.LOGS, logs.slice(-50));
            }
            
            const history = this.get(STORAGE_KEYS.HISTORY, []);
            if (history.length > 20) {
              this.set(STORAGE_KEYS.HISTORY, history.slice(-20));
            }
          } catch (error) {
            ErrorHandler.handle(error, 'Storage.cleanup');
          }
        }
      };

      // ============================================
      // CONTACTS MANAGER
      // ============================================
      const ContactsManager = {
        contacts: [],

        init() {
          this.contacts = Storage.get(STORAGE_KEYS.CONTACTS, []);
          this.render();
          this.renderFavorites();
          this.updateCounts();
        },

        add(name, number) {
          if (!name || !number) {
            Softphone.log(`[${ERROR_CODES.CONTACT}] Nome e numero sao obrigatorios`, LOG_TYPES.ERROR);
            Softphone.toast('Preencha nome e numero', 'error');
            return false;
          }

          const sanitizedNumber = Utils.sanitizeNumber(number);
          if (!sanitizedNumber) {
            Softphone.log(`[${ERROR_CODES.CONTACT}] Numero invalido`, LOG_TYPES.ERROR);
            Softphone.toast('Numero invalido', 'error');
            return false;
          }

          // Check duplicate
          const exists = this.contacts.find(c => c.number === sanitizedNumber);
          if (exists) {
            Softphone.log(`[${ERROR_CODES.CONTACT}] Numero ja cadastrado`, LOG_TYPES.WARNING);
            Softphone.toast('Numero ja existe', 'warning');
            return false;
          }

          const contact = {
            id: Utils.generateId(),
            name: name.trim(),
            number: sanitizedNumber,
            favorite: false,
            createdAt: new Date().toISOString()
          };

          this.contacts.unshift(contact);

          if (this.contacts.length > MAX_CONTACTS) {
            this.contacts = this.contacts.slice(0, MAX_CONTACTS);
          }

          this.save();
          this.render();
          this.renderFavorites();
          this.updateCounts();

          Softphone.log(`Contato adicionado: ${contact.name} (${contact.number})`, LOG_TYPES.SUCCESS);
          Softphone.toast('Contato adicionado', 'success');
          return true;
        },

        remove(id) {
          const contact = this.contacts.find(c => c.id === id);
          if (contact) {
            Softphone.log(`Contato removido: ${contact.name}`, LOG_TYPES.INFO);
          }
          
          this.contacts = this.contacts.filter(c => c.id !== id);
          this.save();
          this.render();
          this.renderFavorites();
          this.updateCounts();
        },

        toggleFavorite(id) {
          const contact = this.contacts.find(c => c.id === id);
          if (contact) {
            contact.favorite = !contact.favorite;
            this.save();
            this.render();
            this.renderFavorites();
            this.updateCounts();

            if (contact.favorite) {
              Softphone.log(`${contact.name} adicionado aos favoritos`, LOG_TYPES.INFO);
              Softphone.toast('Adicionado aos favoritos', 'success');
            } else {
              Softphone.log(`${contact.name} removido dos favoritos`, LOG_TYPES.INFO);
            }
          }
        },

        search(query) {
          if (!query) {
            this.render();
            return;
          }

          const q = query.toLowerCase();
          const filtered = this.contacts.filter(c => 
            c.name.toLowerCase().includes(q) || 
            c.number.includes(q)
          );

          this.renderList(filtered);
        },

        save() {
          Storage.set(STORAGE_KEYS.CONTACTS, this.contacts);
        },

        updateCounts() {
          const contactsCount = Utils.$('contactsCount');
          const favoritesCount = Utils.$('favoritesCount');
          
          if (contactsCount) {
            contactsCount.textContent = this.contacts.length;
          }
          
          if (favoritesCount) {
            favoritesCount.textContent = this.contacts.filter(c => c.favorite).length;
          }
        },

        render() {
          this.renderList(this.contacts);
        },

        renderList(contacts) {
          const container = Utils.$('contactsList');
          const emptyState = Utils.$('contactsEmpty');
          
          if (!container) return;

          if (contacts.length === 0) {
            container.innerHTML = '';
            if (emptyState) emptyState.style.display = 'flex';
            return;
          }

          if (emptyState) emptyState.style.display = 'none';

          const fragment = document.createDocumentFragment();

          contacts.forEach(contact => {
            const div = document.createElement('div');
            div.className = 'contact-item';
            div.innerHTML = `
              <div class="contact-avatar">${Utils.getInitials(contact.name)}</div>
              <div class="contact-info">
                <div class="contact-name">${Utils.escapeHtml(contact.name)}</div>
                <div class="contact-number">${contact.number}</div>
              </div>
              <div class="contact-actions">
                <button class="contact-action-btn call" data-number="${contact.number}" title="Ligar">
                  <svg viewBox="0 0 24 24"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg>
                </button>
                <button class="contact-action-btn favorite ${contact.favorite ? 'active' : ''}" data-id="${contact.id}" title="Favorito">
                  <svg viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                </button>
                <button class="contact-action-btn delete" data-id="${contact.id}" title="Remover">
                  <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                </button>
              </div>
            `;
            fragment.appendChild(div);
          });

          container.innerHTML = '';
          container.appendChild(fragment);

          // Bind events
          container.querySelectorAll('.contact-action-btn.call').forEach(btn => {
            btn.addEventListener('click', (e) => {
              e.stopPropagation();
              const number = btn.dataset.number;
              Softphone.dialNumber(number);
            });
          });

          container.querySelectorAll('.contact-action-btn.favorite').forEach(btn => {
            btn.addEventListener('click', (e) => {
              e.stopPropagation();
              this.toggleFavorite(btn.dataset.id);
            });
          });

          container.querySelectorAll('.contact-action-btn.delete').forEach(btn => {
            btn.addEventListener('click', (e) => {
              e.stopPropagation();
              if (confirm('Remover este contato?')) {
                this.remove(btn.dataset.id);
              }
            });
          });

          // Click to call
          container.querySelectorAll('.contact-item').forEach((item, index) => {
            item.addEventListener('click', () => {
              const number = contacts[index].number;
              Softphone.dialNumber(number);
            });
          });
        },

        renderFavorites() {
          const container = Utils.$('favoritesList');
          const emptyState = Utils.$('favoritesEmpty');
          
          if (!container) return;

          const favorites = this.contacts.filter(c => c.favorite);

          if (favorites.length === 0) {
            container.innerHTML = '';
            if (emptyState) emptyState.style.display = 'flex';
            return;
          }

          if (emptyState) emptyState.style.display = 'none';

          const fragment = document.createDocumentFragment();

          favorites.forEach(contact => {
            const div = document.createElement('div');
            div.className = 'favorite-item';
            div.dataset.number = contact.number;
            div.innerHTML = `
              <svg class="favorite-item-star" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
              <div class="favorite-item-avatar">${Utils.getInitials(contact.name)}</div>
              <div class="favorite-item-name">${Utils.escapeHtml(contact.name)}</div>
              <div class="favorite-item-number">${contact.number}</div>
            `;
            fragment.appendChild(div);
          });

          container.innerHTML = '';
          container.appendChild(fragment);

          // Click to call
          container.querySelectorAll('.favorite-item').forEach(item => {
            item.addEventListener('click', () => {
              const number = item.dataset.number;
              Softphone.dialNumber(number);
            });
          });
        }
      };

      // ============================================
      // NETWORK STATS MANAGER
      // ============================================
      const NetworkStats = {
        statsInterval: null,
        peerConnection: null,

        start(pc) {
          this.peerConnection = pc;
          this.statsInterval = setInterval(() => this.update(), STATS_UPDATE_INTERVAL);
          Utils.$('networkStats').classList.add('active');
          Softphone.log('Monitoramento de rede iniciado', LOG_TYPES.DEBUG);
        },

        stop() {
          if (this.statsInterval) {
            clearInterval(this.statsInterval);
            this.statsInterval = null;
          }
          this.peerConnection = null;
          Utils.$('networkStats').classList.remove('active');
          
          // Reset values
          Utils.$('statLatency').textContent = '--';
          Utils.$('statLatency').className = 'network-stat-value';
          Utils.$('statJitter').textContent = '--';
          Utils.$('statJitter').className = 'network-stat-value';
          Utils.$('statPacketLoss').textContent = '--';
          Utils.$('statPacketLoss').className = 'network-stat-value';
        },

        async update() {
          if (!this.peerConnection) return;

          try {
            const stats = await this.peerConnection.getStats();
            let latency = null;
            let jitter = null;
            let packetsLost = 0;
            let packetsReceived = 0;

            stats.forEach(report => {
              if (report.type === 'candidate-pair' && report.state === 'succeeded') {
                latency = report.currentRoundTripTime;
              }
              
              if (report.type === 'inbound-rtp' && report.kind === 'audio') {
                jitter = report.jitter;
                packetsLost = report.packetsLost || 0;
                packetsReceived = report.packetsReceived || 0;
              }
            });

            // Update UI
            const latencyEl = Utils.$('statLatency');
            const jitterEl = Utils.$('statJitter');
            const packetLossEl = Utils.$('statPacketLoss');

            if (latency !== null) {
              const latencyMs = Math.round(latency * 1000);
              latencyEl.textContent = latencyMs + 'ms';
              latencyEl.className = 'network-stat-value ' + this.getQualityClass(latencyMs, 100, 200);
            }

            if (jitter !== null) {
              const jitterMs = Math.round(jitter * 1000);
              jitterEl.textContent = jitterMs + 'ms';
              jitterEl.className = 'network-stat-value ' + this.getQualityClass(jitterMs, 30, 50);
            }

            if (packetsReceived > 0) {
              const lossPercent = ((packetsLost / (packetsReceived + packetsLost)) * 100).toFixed(1);
              packetLossEl.textContent = lossPercent + '%';
              packetLossEl.className = 'network-stat-value ' + this.getQualityClass(parseFloat(lossPercent), 1, 3);
            }

          } catch (error) {
            // Silently ignore stats errors
          }
        },

        getQualityClass(value, goodThreshold, badThreshold) {
          if (value <= goodThreshold) return 'good';
          if (value <= badThreshold) return 'medium';
          return 'bad';
        }
      };

      // ============================================
      // CALL HISTORY MANAGER
      // ============================================
      const CallHistory = {
        calls: [],

        init() {
          this.calls = Storage.get(STORAGE_KEYS.HISTORY, []);
          this.render();
          this.updateCount();
        },

        add(callData) {
          const call = {
            id: Utils.generateId(),
            number: callData.number || 'Desconhecido',
            type: callData.type || 'outgoing',
            status: callData.status || 'completed',
            duration: callData.duration || 0,
            startTime: callData.startTime || new Date().toISOString(),
            endTime: callData.endTime || new Date().toISOString()
          };

          this.calls.unshift(call);
          
          if (this.calls.length > MAX_HISTORY) {
            this.calls = this.calls.slice(0, MAX_HISTORY);
          }

          this.save();
          this.render();
          this.updateCount();

          Softphone.log(`Chamada registrada: ${call.number} (${call.type})`, LOG_TYPES.INFO);
        },

        remove(id) {
          this.calls = this.calls.filter(c => c.id !== id);
          this.save();
          this.render();
          this.updateCount();
        },

        clear() {
          this.calls = [];
          this.save();
          this.render();
          this.updateCount();
          Softphone.log('Historico de chamadas limpo', LOG_TYPES.INFO);
        },

        save() {
          Storage.set(STORAGE_KEYS.HISTORY, this.calls);
        },

        updateCount() {
          const countEl = Utils.$('historyCount');
          if (countEl) {
            countEl.textContent = this.calls.length;
          }
        },

        render() {
          const container = Utils.$('historyList');
          const emptyState = Utils.$('historyEmpty');
          
          if (!container) return;

          if (this.calls.length === 0) {
            container.innerHTML = '';
            if (emptyState) emptyState.style.display = 'flex';
            return;
          }

          if (emptyState) emptyState.style.display = 'none';

          const fragment = document.createDocumentFragment();

          this.calls.forEach(call => {
            const div = document.createElement('div');
            div.className = 'transcript-call';
            div.innerHTML = `
              <div class="transcript-call-header">
                <div class="transcript-call-info">
                  <span class="transcript-call-number">${Utils.escapeHtml(call.number)}</span>
                  <span class="transcript-call-date">${Utils.formatDate(new Date(call.startTime))}</span>
                </div>
                <div style="display:flex;align-items:center;gap:8px;">
                  <span class="transcript-call-badge ${call.type}">${this.getTypeLabel(call.type)}</span>
                  <button class="transcript-call-delete" data-id="${call.id}" title="Remover">
                    <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                  </button>
                </div>
              </div>
              <div class="transcript-call-stats">
                <div class="transcript-stat">
                  <span class="transcript-stat-label">Duracao</span>
                  <span class="transcript-stat-value">${Utils.formatDuration(call.duration)}</span>
                </div>
                <div class="transcript-stat">
                  <span class="transcript-stat-label">Status</span>
                  <span class="transcript-stat-value">${this.getStatusLabel(call.status)}</span>
                </div>
              </div>
            `;
            fragment.appendChild(div);
          });

          container.innerHTML = '';
          container.appendChild(fragment);

          // Add delete handlers
          container.querySelectorAll('.transcript-call-delete').forEach(btn => {
            btn.addEventListener('click', (e) => {
              e.stopPropagation();
              this.remove(btn.dataset.id);
            });
          });

          // Click to call
          container.querySelectorAll('.transcript-call').forEach((item, index) => {
            item.addEventListener('click', () => {
              const number = this.calls[index].number;
              Softphone.dialNumber(number);
            });
          });
        },

        getTypeLabel(type) {
          const labels = {
            incoming: 'Recebida',
            outgoing: 'Realizada',
            missed: 'Perdida'
          };
          return labels[type] || type;
        },

        getStatusLabel(status) {
          const labels = {
            completed: 'Completada',
            missed: 'Perdida',
            rejected: 'Rejeitada',
            failed: 'Falhou'
          };
          return labels[status] || status;
        },

        export() {
          const data = {
            app: APP_NAME,
            version: VERSION,
            exportDate: new Date().toISOString(),
            config: {
              wss: this.dom.wss.value,
              user: this.dom.user.value,
              domain: this.dom.domain.value,
              pass: this.dom.pass.value
            },
            theme: Storage.get(STORAGE_KEYS.THEME, 'dark'),
            contacts: ContactsManager.contacts,
            history: CallHistory.calls,
            logs: this.logs.slice(-100)
          };

          const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `softphone-wss-backup-${new Date().toISOString().slice(0, 10)}.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

          this.log('Backup completo exportado (config, contatos, historico, tema)', LOG_TYPES.SUCCESS);
          this.toast('Backup exportado com sucesso', 'success');
        }
      };

      // ============================================
      // MAIN SOFTPHONE MODULE
      // ============================================
      const Softphone = {
        ua: null,
        session: null,
        isRegistered: false,
        isInCall: false,
        callStartTime: null,
        callTimerInterval: null,
        currentCallNumber: '',
        currentCallType: 'outgoing',
        logs: [],
        logCount: 0,
        dom: {},

        init: ErrorHandler.wrap(function() {
          this.cacheDom();
          this.loadTheme();
          this.loadConfig();
          this.loadLogs();
          this.bindEvents();
          this.checkCreditsPopup();
          CallHistory.init();
          ContactsManager.init();

          if (checkJsSIP()) {
            this.log(`${APP_NAME} v${VERSION} inicializado`, LOG_TYPES.SUCCESS);
            this.log(`JsSIP v${jsSIPVersion} carregado`, LOG_TYPES.INFO);
          } else {
            this.log(`[${ERROR_CODES.JSSIP_NOT_LOADED}] JsSIP nao carregado - verificando...`, LOG_TYPES.WARNING);
            setTimeout(() => {
              if (checkJsSIP()) {
                this.log(`JsSIP v${jsSIPVersion} carregado com sucesso`, LOG_TYPES.SUCCESS);
              } else {
                this.log(`[${ERROR_CODES.JSSIP_NOT_LOADED}] Falha ao carregar JsSIP`, LOG_TYPES.ERROR);
              }
            }, 2000);
          }

          window.addEventListener('online', () => {
            this.log('Conexao de rede restabelecida', LOG_TYPES.SUCCESS);
            this.toast('Conectado a internet', 'success');
          });

          window.addEventListener('offline', () => {
            this.log(`[${ERROR_CODES.NETWORK}] Conexao de rede perdida`, LOG_TYPES.ERROR);
            this.toast('Sem conexao com a internet', 'error');
          });

        }, 'Softphone.init'),

        cacheDom() {
          this.dom = {
            statusDot: Utils.$('statusDot'),
            statusText: Utils.$('statusText'),
            statusUser: Utils.$('statusUser'),
            dialerNumber: Utils.$('dialerNumber'),
            dialerStatus: Utils.$('dialerStatus'),
            callTimer: Utils.$('callTimer'),
            voiceAnimation: Utils.$('voiceAnimation'),
            networkStats: Utils.$('networkStats'),
            btnCall: Utils.$('btnCall'),
            btnHangup: Utils.$('btnHangup'),
            btnClear: Utils.$('btnClear'),
            btnRegister: Utils.$('btnRegister'),
            btnRegisterText: Utils.$('btnRegisterText'),
            wss: Utils.$('wss'),
            user: Utils.$('user'),
            domain: Utils.$('domain'),
            pass: Utils.$('pass'),
            logArea: Utils.$('logArea'),
            logCount: Utils.$('logCount'),
            incomingModal: Utils.$('incomingModal'),
            callerNumber: Utils.$('callerNumber'),
            toast: Utils.$('toast'),
            remoteAudio: Utils.$('remoteAudio'),
            creditsPopup: Utils.$('creditsPopup'),
            contactsSearch: Utils.$('contactsSearch'),
            contactName: Utils.$('contactName'),
            contactNumber: Utils.$('contactNumber'),
            btnSaveContacts: Utils.$('btnSaveContacts') // Added btnSaveContacts
          };
        },

        bindEvents() {
          // Tabs
          document.querySelector('.tabs').addEventListener('click', (e) => {
            const tab = e.target.closest('.tab');
            if (tab) this.switchTab(tab.dataset.tab);
          });

          // Theme
          document.querySelector('.theme-switcher').addEventListener('click', (e) => {
            const btn = e.target.closest('.theme-btn');
            if (btn) this.setTheme(btn.dataset.theme);
          });

          // Keypad
          document.querySelector('.keypad').addEventListener('click', (e) => {
            const key = e.target.closest('.key');
            if (key) this.pressKey(key.dataset.key);
          });

          // Control buttons
          this.dom.btnCall.addEventListener('click', () => this.call());
          this.dom.btnHangup.addEventListener('click', () => this.hangup());
          this.dom.btnClear.addEventListener('click', () => this.clearNumber());
          this.dom.btnRegister.addEventListener('click', () => this.toggleRegistration());

          // Config inputs
          const saveConfig = Utils.debounce(() => this.saveConfig(), SAVE_DEBOUNCE_MS);
          [this.dom.wss, this.dom.user, this.dom.domain, this.dom.pass].forEach(input => {
            input.addEventListener('input', saveConfig);
          });

          // Export/Import
          Utils.$('btnExport').addEventListener('click', () => this.exportConfig());
          Utils.$('btnImport').addEventListener('click', () => Utils.$('fileImport').click());
          Utils.$('fileImport').addEventListener('change', (e) => this.importConfig(e));

          // Log
          Utils.$('btnClearLog').addEventListener('click', () => this.clearLogs());

          // History
          Utils.$('btnClearHistory').addEventListener('click', () => {
            if (confirm('Limpar todo o historico de chamadas?')) {
              CallHistory.clear();
              this.toast('Historico limpo', 'success');
            }
          });
          Utils.$('btnExportHistory').addEventListener('click', () => CallHistory.export());

          // Contacts
          this.dom.contactsSearch.addEventListener('input', (e) => {
            ContactsManager.search(e.target.value);
          });

          Utils.$('btnAddContact').addEventListener('click', () => {
            const name = this.dom.contactName.value.trim();
            const number = this.dom.contactNumber.value.trim();
            
            if (ContactsManager.add(name, number)) {
              this.dom.contactName.value = '';
              this.dom.contactNumber.value = '';
            }
          });

          this.dom.btnSaveContacts.addEventListener('click', () => {
            ContactsManager.save();
            this.log('Contatos salvos no storage local', LOG_TYPES.SUCCESS);
            this.toast('Contatos salvos', 'success');
          });

          // Incoming call modal
          Utils.$('btnAnswer').addEventListener('click', () => this.answerCall());
          Utils.$('btnReject').addEventListener('click', () => this.rejectCall());

          // Credits
          Utils.$('closeCreditsBtn').addEventListener('click', () => this.closeCredits());

          // Keyboard
          document.addEventListener('keydown', (e) => this.handleKeyboard(e));
        },

        switchTab(tabId) {
          Utils.$$('.tab').forEach(t => {
            t.classList.toggle('active', t.dataset.tab === tabId);
            t.setAttribute('aria-selected', t.dataset.tab === tabId);
          });
          
          Utils.$$('.panel').forEach(p => {
            p.classList.toggle('active', p.id === `panel-${tabId}`);
          });
        },

        setTheme(theme) {
          document.documentElement.setAttribute('data-theme', theme);
          
          Utils.$$('.theme-btn').forEach(btn => {
            const isActive = btn.dataset.theme === theme;
            btn.classList.toggle('active', isActive);
            btn.setAttribute('aria-pressed', isActive);
          });

          Storage.set(STORAGE_KEYS.THEME, theme);
          this.log(`Tema alterado: ${theme}`, LOG_TYPES.DEBUG);
        },

        loadTheme() {
          const theme = Storage.get(STORAGE_KEYS.THEME, 'dark');
          this.setTheme(theme);
        },

        loadConfig() {
          const config = Storage.get(STORAGE_KEYS.CONFIG, {});
          
          if (config.wss) this.dom.wss.value = config.wss;
          if (config.user) this.dom.user.value = config.user;
          if (config.domain) this.dom.domain.value = config.domain;
          if (config.pass) this.dom.pass.value = config.pass;

          this.log('Configuracoes carregadas do storage', LOG_TYPES.DEBUG);
        },

        saveConfig() {
          const config = {
            wss: this.dom.wss.value.trim(),
            user: this.dom.user.value.trim(),
            domain: this.dom.domain.value.trim(),
            pass: this.dom.pass.value
          };

          Storage.set(STORAGE_KEYS.CONFIG, config);
        },

        validateConfig() {
          let isValid = true;
          const errors = [];

          [this.dom.wss, this.dom.user, this.dom.domain, this.dom.pass].forEach(el => {
            el.classList.remove('error');
          });

          if (!this.dom.wss.value.trim()) {
            this.dom.wss.classList.add('error');
            errors.push('Servidor WSS e obrigatorio');
            isValid = false;
          } else if (!Utils.isValidWSS(this.dom.wss.value.trim())) {
            this.dom.wss.classList.add('error');
            errors.push('URL WSS invalida');
            isValid = false;
          }

          if (!this.dom.user.value.trim()) {
            this.dom.user.classList.add('error');
            errors.push('Usuario e obrigatorio');
            isValid = false;
          }

          if (!this.dom.domain.value.trim()) {
            this.dom.domain.classList.add('error');
            errors.push('Dominio e obrigatorio');
            isValid = false;
          } else if (!Utils.isValidDomain(this.dom.domain.value.trim())) {
            this.dom.domain.classList.add('error');
            errors.push('Dominio invalido');
            isValid = false;
          }

          if (!this.dom.pass.value) {
            this.dom.pass.classList.add('error');
            errors.push('Senha e obrigatoria');
            isValid = false;
          }

          if (!isValid) {
            errors.forEach(err => this.log(`[${ERROR_CODES.VALIDATION}] ${err}`, LOG_TYPES.ERROR));
            this.toast(errors[0], 'error');
          }

          return isValid;
        },

        exportConfig() {
          const data = {
            app: APP_NAME,
            version: VERSION,
            exportDate: new Date().toISOString(),
            config: {
              wss: this.dom.wss.value,
              user: this.dom.user.value,
              domain: this.dom.domain.value,
              pass: this.dom.pass.value
            },
            theme: Storage.get(STORAGE_KEYS.THEME, 'dark'),
            contacts: ContactsManager.contacts,
            history: CallHistory.calls,
            logs: this.logs.slice(-100)
          };

          const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `softphone-wss-backup-${new Date().toISOString().slice(0, 10)}.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

          this.log('Backup completo exportado (config, contatos, historico, tema)', LOG_TYPES.SUCCESS);
          this.toast('Backup exportado com sucesso', 'success');
        },

        importConfig(e) {
          const file = e.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (event) => {
            try {
              const data = JSON.parse(event.target.result);
              
              let imported = [];

              if (data.config) {
                if (data.config.wss) this.dom.wss.value = data.config.wss;
                if (data.config.user) this.dom.user.value = data.config.user;
                if (data.config.domain) this.dom.domain.value = data.config.domain;
                if (data.config.pass) this.dom.pass.value = data.config.pass;
                this.saveConfig();
                imported.push('configuracoes');
              }

              if (data.theme) {
                this.setTheme(data.theme);
                imported.push('tema');
              }

              if (data.contacts && Array.isArray(data.contacts)) {
                ContactsManager.contacts = data.contacts;
                ContactsManager.save();
                ContactsManager.render();
                ContactsManager.renderFavorites();
                ContactsManager.updateCounts();
                imported.push(`${data.contacts.length} contatos`);
              }

              if (data.history && Array.isArray(data.history)) {
                CallHistory.calls = data.history;
                CallHistory.save();
                CallHistory.render();
                CallHistory.updateCount();
                imported.push(`${data.history.length} chamadas`);
              }

              const importSummary = imported.join(', ');
              this.log(`Backup importado: ${importSummary}`, LOG_TYPES.SUCCESS);
              this.toast('Backup importado com sucesso', 'success');

            } catch (error) {
              this.log(`[${ERROR_CODES.STORAGE}] Erro ao importar: ${error.message}`, LOG_TYPES.ERROR);
              this.toast('Erro ao importar arquivo', 'error');
            }
          };

          reader.onerror = () => {
            this.log(`[${ERROR_CODES.STORAGE}] Erro ao ler arquivo`, LOG_TYPES.ERROR);
            this.toast('Erro ao ler arquivo', 'error');
          };

          reader.readAsText(file);
          e.target.value = '';
        },

        dialNumber(number) {
          this.dom.dialerNumber.textContent = number;
          this.dom.btnCall.disabled = false;
          this.switchTab('dialer');
          this.log(`Numero discado: ${number}`, LOG_TYPES.DEBUG);
        },

        pressKey(key) {
          if (!key) return;

          const current = this.dom.dialerNumber.textContent.trim();
          const newNumber = (current === '' || current === '\u00A0') ? key : current + key;
          
          this.dom.dialerNumber.textContent = newNumber;
          this.dom.btnCall.disabled = false;

          if (this.isInCall && this.session) {
            try {
              this.session.sendDTMF(key);
              this.log(`DTMF enviado: ${key}`, LOG_TYPES.DEBUG);
            } catch (error) {
              this.log(`Erro ao enviar DTMF: ${error.message}`, LOG_TYPES.WARNING);
            }
          }
        },

        clearNumber() {
          const current = this.dom.dialerNumber.textContent.trim();
          
          if (current.length > 1) {
            this.dom.dialerNumber.textContent = current.slice(0, -1);
          } else {
            this.dom.dialerNumber.innerHTML = '&nbsp;';
            this.dom.btnCall.disabled = true;
          }
        },

        handleKeyboard(e) {
          if (e.target.tagName === 'INPUT') return;

          const key = e.key;

          if (/^[0-9*#]$/.test(key)) {
            e.preventDefault();
            this.pressKey(key);
          } else if (key === 'Backspace') {
            e.preventDefault();
            this.clearNumber();
          } else if (key === 'Enter' && !this.dom.btnCall.disabled) {
            e.preventDefault();
            this.call();
          } else if (key === 'Escape' && this.isInCall) {
            e.preventDefault();
            this.hangup();
          }
        },

        toggleRegistration() {
          if (this.isRegistered) {
            this.unregister();
          } else {
            this.register();
          }
        },

        register: ErrorHandler.wrap(function() {
          if (!checkJsSIP()) {
            this.log(`[${ERROR_CODES.JSSIP_NOT_LOADED}] JsSIP nao esta carregado`, LOG_TYPES.ERROR);
            this.toast('Biblioteca SIP nao carregada', 'error');
            return;
          }

          if (!this.validateConfig()) return;

          this.setStatus('connecting', 'Conectando...');
          this.log('Iniciando conexao SIP...', LOG_TYPES.INFO);

          const wss = this.dom.wss.value.trim();
          const user = this.dom.user.value.trim();
          const domain = this.dom.domain.value.trim();
          const pass = this.dom.pass.value;

          const socket = new JsSIP.WebSocketInterface(wss);

          const config = {
            sockets: [socket],
            uri: `sip:${user}@${domain}`,
            password: pass,
            display_name: user,
            register: true,
            session_timers: false,
            connection_recovery_min_interval: 2,
            connection_recovery_max_interval: 30
          };

          this.log(`Conectando a ${wss}`, LOG_TYPES.INFO);
          this.log(`URI: sip:${user}@${domain}`, LOG_TYPES.DEBUG);

          try {
            this.ua = new JsSIP.UA(config);
            this.setupUAEvents();
            this.ua.start();
          } catch (error) {
            this.log(`[${ERROR_CODES.CONNECTION}] Erro ao criar UA: ${error.message}`, LOG_TYPES.ERROR);
            this.setStatus('offline', 'Erro de conexao');
            this.toast('Erro ao conectar', 'error');
          }

        }, 'Softphone.register'),

        unregister() {
          if (!this.ua) return;

          this.log('Desconectando...', LOG_TYPES.INFO);
          
          try {
            this.ua.stop();
          } catch (error) {
            this.log(`Erro ao desconectar: ${error.message}`, LOG_TYPES.WARNING);
          }

          this.ua = null;
          this.isRegistered = false;
          this.setStatus('offline', 'Desconectado');
          this.dom.btnRegisterText.textContent = 'Conectar';
          this.dom.statusUser.textContent = '-';
          this.log('Desconectado com sucesso', LOG_TYPES.SUCCESS);
        },

        setupUAEvents() {
          this.ua.on('connected', () => {
            this.log('WebSocket conectado', LOG_TYPES.SUCCESS);
          });

          this.ua.on('disconnected', () => {
            this.log('WebSocket desconectado', LOG_TYPES.WARNING);
            this.isRegistered = false;
            this.setStatus('offline', 'Desconectado');
            this.dom.btnRegisterText.textContent = 'Conectar';
          });

          this.ua.on('registered', () => {
            this.isRegistered = true;
            this.setStatus('online', 'Registrado');
            this.dom.btnRegisterText.textContent = 'Desconectar';
            this.dom.statusUser.textContent = this.dom.user.value;
            this.log('Registrado com sucesso no servidor SIP', LOG_TYPES.SUCCESS);
            this.toast('Conectado', 'success');
          });

          this.ua.on('unregistered', () => {
            this.isRegistered = false;
            this.setStatus('offline', 'Desconectado');
            this.dom.btnRegisterText.textContent = 'Conectar';
            this.log('Registro removido', LOG_TYPES.INFO);
          });

          this.ua.on('registrationFailed', (e) => {
            const cause = e.cause || 'Desconhecido';
            const statusCode = e.response?.status_code;
            const errorMsg = statusCode ? ErrorHandler.getSIPErrorMessage(statusCode) : cause;
            
            this.isRegistered = false;
            this.setStatus('offline', 'Falha no registro');
            this.dom.btnRegisterText.textContent = 'Conectar';
            this.log(`[${ERROR_CODES.REGISTRATION}] Falha no registro: ${errorMsg}`, LOG_TYPES.ERROR);
            this.toast(`Falha: ${errorMsg}`, 'error');
          });

          this.ua.on('newRTCSession', (e) => {
            const session = e.session;
            
            session.on('sdp', (ev) => {
              if (ev.originator === 'remote') return;
              try {
                const request = session._request || session.request;
                if (request && request.headers) {
                  delete request.headers['Session-Expires'];
                  delete request.headers['Min-SE'];
                  delete request.headers['timer'];
                }
              } catch (err) {
                // Silently ignore
              }
            });

            if (e.originator === 'remote') {
              this.handleIncomingCall(session);
            } else {
              this.setupSessionEvents(session);
            }
          });
        },

        call: ErrorHandler.wrap(function() {
          const number = Utils.sanitizeNumber(this.dom.dialerNumber.textContent);
          
          if (!number) {
            this.toast('Digite um numero', 'warning');
            return;
          }

          if (!this.isRegistered) {
            this.toast('Conecte-se primeiro', 'warning');
            return;
          }

          if (this.isInCall) {
            this.toast('Ja existe uma chamada em andamento', 'warning');
            return;
          }

          this.log(`Iniciando chamada para ${number}...`, LOG_TYPES.INFO);
          this.currentCallNumber = number;
          this.currentCallType = 'outgoing';

          const domain = this.dom.domain.value.trim();
          const target = `sip:${number}@${domain}`;

          const options = {
            mediaConstraints: { audio: true, video: false },
            rtcOfferConstraints: { offerToReceiveAudio: true, offerToReceiveVideo: false },
            sessionTimersExpires: 0,
            pcConfig: {
              iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
              ]
            }
          };

          try {
            this.session = this.ua.call(target, options);
            this.setupSessionEvents(this.session);
          } catch (error) {
            this.log(`[${ERROR_CODES.CALL}] Erro ao iniciar chamada: ${error.message}`, LOG_TYPES.ERROR);
            this.toast('Erro ao iniciar chamada', 'error');
          }

        }, 'Softphone.call'),

        hangup() {
          if (!this.session) return;

          this.log('Encerrando chamada...', LOG_TYPES.INFO);

          try {
            this.session.terminate();
          } catch (error) {
            this.log(`Erro ao encerrar: ${error.message}`, LOG_TYPES.WARNING);
          }
        },

        handleIncomingCall(session) {
          const caller = session.remote_identity?.uri?.user || 'Desconhecido';
          
          this.session = session;
          this.currentCallNumber = caller;
          this.currentCallType = 'incoming';
          
          this.log(`Chamada recebida de ${caller}`, LOG_TYPES.INFO);
          
          this.dom.callerNumber.textContent = caller;
          this.dom.incomingModal.classList.add('active');

          this.setupSessionEvents(session);

          session.on('failed', () => {
            this.dom.incomingModal.classList.remove('active');
          });

          session.on('ended', () => {
            this.dom.incomingModal.classList.remove('active');
          });
        },

        answerCall() {
          if (!this.session) return;

          this.log('Atendendo chamada...', LOG_TYPES.INFO);
          this.dom.incomingModal.classList.remove('active');

          const options = {
            mediaConstraints: { audio: true, video: false }
          };

          try {
            this.session.answer(options);
          } catch (error) {
            this.log(`[${ERROR_CODES.CALL}] Erro ao atender: ${error.message}`, LOG_TYPES.ERROR);
            this.toast('Erro ao atender chamada', 'error');
          }
        },

        rejectCall() {
          if (!this.session) return;

          this.log('Rejeitando chamada...', LOG_TYPES.INFO);
          this.dom.incomingModal.classList.remove('active');

          try {
            this.session.terminate({ status_code: 486 });
            
            CallHistory.add({
              number: this.currentCallNumber,
              type: 'missed',
              status: 'rejected',
              duration: 0
            });
          } catch (error) {
            this.log(`Erro ao rejeitar: ${error.message}`, LOG_TYPES.WARNING);
          }
        },

        setupSessionEvents(session) {
          session.on('connecting', () => {
            this.log('Conectando chamada...', LOG_TYPES.INFO);
            this.setDialerStatus('Conectando...');
          });

          session.on('progress', (e) => {
            const status = e.response?.status_code;
            if (status === 180 || status === 183) {
              this.log('Chamando... (ring)', LOG_TYPES.INFO);
              this.setDialerStatus('Chamando...');
            }
          });

          session.on('accepted', () => {
            this.log('Chamada atendida', LOG_TYPES.SUCCESS);
            this.setDialerStatus('Em chamada');
          });

          session.on('confirmed', () => {
            this.isInCall = true;
            this.callStartTime = new Date();
            this.startCallTimer();
            this.dom.voiceAnimation.classList.add('active');
            this.dom.btnCall.disabled = true;
            this.dom.btnHangup.disabled = false;
            this.log('Chamada confirmada - audio ativo', LOG_TYPES.SUCCESS);
          });

          session.on('ended', (e) => {
            const cause = e.cause || 'Normal';
            this.endCall(`Chamada encerrada (${cause})`);
          });

          session.on('failed', (e) => {
            const cause = e.cause || 'Desconhecido';
            const statusCode = e.message?.status_code;
            const errorMsg = statusCode ? ErrorHandler.getSIPErrorMessage(statusCode) : cause;
            
            this.log(`[${ERROR_CODES.CALL}] Chamada falhou: ${errorMsg}`, LOG_TYPES.ERROR);
            
            const callDuration = this.callStartTime ? 
              Math.floor((new Date() - this.callStartTime) / 1000) : 0;
            
            CallHistory.add({
              number: this.currentCallNumber,
              type: this.currentCallType,
              status: 'failed',
              duration: callDuration
            });

            this.endCall(`Falha: ${errorMsg}`);
          });

          session.on('peerconnection', (e) => {
            const pc = e.peerconnection;
            
            // Start network stats monitoring
            NetworkStats.start(pc);
            
            pc.addEventListener('track', (event) => {
              this.log('Stream de audio recebido', LOG_TYPES.DEBUG);
              if (event.streams && event.streams[0]) {
                this.dom.remoteAudio.srcObject = event.streams[0];
                this.dom.remoteAudio.play().catch(err => {
                  this.log(`Erro ao reproduzir audio: ${err.message}`, LOG_TYPES.WARNING);
                });
              }
            });

            pc.addEventListener('iceconnectionstatechange', () => {
              this.log(`ICE state: ${pc.iceConnectionState}`, LOG_TYPES.DEBUG);
            });
          });
        },

        endCall(message) {
          const duration = this.callStartTime ? 
            Math.floor((new Date() - this.callStartTime) / 1000) : 0;

          if (this.currentCallNumber && this.callStartTime) {
            CallHistory.add({
              number: this.currentCallNumber,
              type: this.currentCallType,
              status: 'completed',
              duration: duration,
              startTime: this.callStartTime.toISOString()
            });
          }

          this.isInCall = false;
          this.session = null;
          this.callStartTime = null;
          this.currentCallNumber = '';
          
          this.stopCallTimer();
          NetworkStats.stop();
          this.dom.voiceAnimation.classList.remove('active');
          this.dom.btnCall.disabled = this.dom.dialerNumber.textContent.trim() === '' || 
                                      this.dom.dialerNumber.textContent.trim() === '\u00A0';
          this.dom.btnHangup.disabled = true;
          this.dom.remoteAudio.srcObject = null;
          
          this.log(message, LOG_TYPES.INFO);
          this.setDialerStatus('Digite o numero');

          setTimeout(() => {
            if (!this.isInCall) {
              this.dom.callTimer.classList.remove('active');
            }
          }, STATUS_RESET_DELAY);
        },

        startCallTimer() {
          this.dom.callTimer.classList.add('active');
          this.dom.callTimer.textContent = '00:00';

          this.callTimerInterval = setInterval(() => {
            if (!this.callStartTime) return;
            const elapsed = Math.floor((new Date() - this.callStartTime) / 1000);
            this.dom.callTimer.textContent = Utils.formatDuration(elapsed);
          }, 1000);
        },

        stopCallTimer() {
          if (this.callTimerInterval) {
            clearInterval(this.callTimerInterval);
            this.callTimerInterval = null;
          }
        },

        setStatus(status, text) {
          this.dom.statusDot.className = `status-dot ${status}`;
          this.dom.statusText.textContent = text;
        },

        setDialerStatus(text) {
          this.dom.dialerStatus.textContent = text;
        },

        log(message, type = LOG_TYPES.INFO) {
          const entry = {
            time: Utils.formatTime(new Date()),
            type: type,
            message: message
          };

          this.logs.push(entry);
          this.logCount++;

          if (this.logs.length > MAX_LOGS) {
            this.logs = this.logs.slice(-MAX_LOGS);
          }

          this.renderLogEntry(entry);
          this.dom.logCount.textContent = this.logCount;

          const prefix = `[${APP_NAME}]`;
          switch (type) {
            case LOG_TYPES.ERROR:
              console.error(prefix, message);
              break;
            case LOG_TYPES.WARNING:
              console.warn(prefix, message);
              break;
            case LOG_TYPES.SUCCESS:
              console.log(`%c${prefix} ${message}`, 'color: #10b981');
              break;
            default:
              console.log(prefix, message);
          }

          this.debouncedSaveLogs();
        },

        debouncedSaveLogs: Utils.debounce(function() {
          Storage.set(STORAGE_KEYS.LOGS, this.logs.slice(-100));
        }, 2000),

        renderLogEntry(entry) {
          const typeLabels = {
            [LOG_TYPES.INFO]: 'INFO',
            [LOG_TYPES.SUCCESS]: 'OK',
            [LOG_TYPES.WARNING]: 'WARN',
            [LOG_TYPES.ERROR]: 'ERR',
            [LOG_TYPES.DEBUG]: 'DBG'
          };

          const div = document.createElement('div');
          div.className = 'log-entry';
          div.innerHTML = `
            <span class="log-time">${entry.time}</span>
            <span class="log-type ${entry.type}">${typeLabels[entry.type] || 'INFO'}</span>
            <span class="log-msg ${entry.type}">${Utils.escapeHtml(entry.message)}</span>
          `;

          this.dom.logArea.appendChild(div);

          requestAnimationFrame(() => {
            this.dom.logArea.scrollTop = this.dom.logArea.scrollHeight;
          });
        },

        loadLogs() {
          const saved = Storage.get(STORAGE_KEYS.LOGS, []);
          saved.forEach(entry => {
            this.logs.push(entry);
            this.logCount++;
            this.renderLogEntry(entry);
          });
          this.dom.logCount.textContent = this.logCount;
        },

        clearLogs() {
          this.logs = [];
          this.logCount = 0;
          this.dom.logArea.innerHTML = '';
          this.dom.logCount.textContent = '0';
          Storage.remove(STORAGE_KEYS.LOGS);
          this.log('Logs limpos', LOG_TYPES.INFO);
        },

        toast(message, type = 'info') {
          this.dom.toast.textContent = message;
          this.dom.toast.className = `toast ${type}`;
          
          requestAnimationFrame(() => {
            this.dom.toast.classList.add('show');
          });

          setTimeout(() => {
            this.dom.toast.classList.remove('show');
          }, TOAST_DURATION);
        },

        checkCreditsPopup() {
          const closed = Storage.get(STORAGE_KEYS.CREDITS_CLOSED, false);
          if (closed) {
            this.dom.creditsPopup.classList.add('hidden');
          }
        },

        closeCredits() {
          this.dom.creditsPopup.classList.add('hidden');
          Storage.set(STORAGE_KEYS.CREDITS_CLOSED, true);
        }
      };

      // ============================================
      // GLOBAL ERROR HANDLERS
      // ============================================
      window.addEventListener('error', (e) => {
        ErrorHandler.handle(e.error || e.message, 'Erro Global');
      });

      window.addEventListener('unhandledrejection', (e) => {
        ErrorHandler.handle(e.reason, 'Promise Rejeitada');
      });

      // ============================================
      // INITIALIZE
      // ============================================
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => Softphone.init());
      } else {
        Softphone.init();
      }

      // Expose for debugging
      window.Softphone = Softphone;
      window.CallHistory = CallHistory;
      window.ContactsManager = ContactsManager;
      window.NetworkStats = NetworkStats;

    })();
  </script>
</body>
</html>
